generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Place {
  id              String   @id @default(uuid())
  placeId         String   @unique
  slug            String?  @unique
  name            String
  primaryProblem  String?
  primaryType     String?
  address         String?
  phone           String?
  rating          Float?
  userRatingCount Int?
  websiteUrl      String?
  googleMapsUrl   String?
  lat             Float?
  lng             Float?
  socials         String?  // JSON object { facebook: string, instagram: string, ... }
  status          String   @default("NEW") // NEW, CONTACTED, IN_PROGRESS, WON, LOST
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  websiteCheck    WebsiteCheck?
  psiAudits       PsiAudit[]
  screenshots     Screenshot[]
  llmVerdicts     LlmVerdict[]
  opportunities   Opportunity[]
  notes           Note[]
  reviews         Review[]
  uxAudits        UxAudit[]              // [NEW]
  competitorBenchmarks CompetitorBenchmark[] // [NEW]
  opsRecommendations OpsRecommendation[] // [NEW]
  
  // Indexing for common queries
  @@index([placeId])
  @@index([rating, userRatingCount])
  @@index([status])
}

model WebsiteCheck {
  id            String   @id @default(uuid())
  placeId       String   @unique
  place         Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  url           String
  resolvedUrl   String?
  status        String   // "ok", "broken", "no_website"
  https         Boolean  @default(false)
  httpStatus    Int?
  errors        String?  // JSON string or text description
  lastCheckedAt DateTime @default(now())

  @@index([status])
}

model PsiAudit {
  id            String   @id @default(uuid())
  placeId       String
  place         Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  url           String
  strategy      String   // "mobile" | "desktop"
  
  // Core Vitals (0-100)
  performance   Int?
  seo           Int?
  accessibility Int?
  bestPractices Int?
  
  rawJson       String?    // Optional full report (JSON string)
  fetchedAt     DateTime @default(now())
  
  @@index([placeId])
}

model Screenshot {
  id          String   @id @default(uuid())
  placeId     String
  place       Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  url         String
  viewport    String   // "mobile" | "desktop"
  pngPath     String
  createdAt   DateTime @default(now())

  @@index([placeId])
}

model LlmVerdict {
  id                  String   @id @default(uuid())
  placeId             String
  place               Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  url                 String?
  needsIntervention   Boolean  @default(false)
  severity            String?  // "low", "medium", "high"
  reasons             String?    // Array of strings (JSON)
  quickWins           String?    // Array of strings (JSON)
  offerAngle          String?  // Suggested pitch
  modelName           String?
  
  createdAt           DateTime @default(now())

  @@index([placeId])
  @@index([needsIntervention])
}

model Opportunity {
  id          String   @id @default(uuid())
  placeId     String
  place       Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  score       Int      // 0-100
  tier        String   // "A", "B", "C"
  
  // New derived fields
  type        String   // "no_website" | "broken_website" | "poor_mobile" | "seo_opportunity"
  value       String   // "RM 1000 - 3000"
  freshness   String   // "new" | "aging" | "stale"
  
  breakdown   String?    // Scoring components (JSON)
  computedAt  DateTime @default(now())

  @@index([placeId])
  @@index([computedAt])
  @@index([score])
}

model JobRun {
  id          String   @id @default(uuid())
  jobType     String
  status      String   // "running", "completed", "failed"
  startedAt   DateTime @default(now())
  finishedAt  DateTime?
  meta        String?  // JSON string
  error       String?


  @@index([jobType, status])
}

model DailyUsage {
  id     String   @id @default(uuid())
  date   String   // YYYY-MM-DD
  metric String   // DISCOVER, PSI, LLM, SCREENSHOT
  count  Int      @default(0)

  @@unique([date, metric])
}

model Note {
  id        String   @id @default(uuid())
  placeId   String
  place     Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  content   String
  createdAt DateTime @default(now())

  @@index([placeId])
}

model Review {
  id          String   @id @default(uuid())
  placeId     String
  place       Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  authorName  String
  rating      Int
  text        String
  publishTime String?  // Flexible handling of time strings often returned by scrapers
  sentiment   String?  // "positive", "negative", "neutral"
  topics      String?  // JSON array of topics
  images      String?  // JSON array of image URLs
  createdAt   DateTime @default(now())

  @@index([placeId])
}


model UxAudit {
  id              String   @id @default(uuid())
  placeId         String
  place           Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  url             String
  finalUrl        String?
  viewport        String   // "mobile" | "desktop"
  ttcAboveFoldMs  Int?     // Time to contact visible
  clicksToContact Int?     // 0 = visible, 1 = one click away
  contactMethods  String?  // JSON list of detected methods
  blockers        String?  // JSON list of issues (cookie overlay, etc)
  evidencePngPath String?  // Path to screenshot with outlined elements
  
  createdAt       DateTime @default(now())

  @@index([placeId])
}

model CompetitorBenchmark {
  id              String   @id @default(uuid())
  placeId         String
  place           Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  radiusKm        Float
  competitors     String?  // JSON list of competitor summaries
  stats           String?  // JSON stats: density, percentile ranks, gaps
  
  createdAt       DateTime @default(now())

  @@index([placeId])
}

model OpsRecommendation {
  id              String   @id @default(uuid())
  placeId         String
  place           Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  visibilityScore Int      // 0-100
  conversionScore Int      // 0-100
  opsScore        Int      // 0-100
  
  offerType       String   // "GBP_CONVERSION" | "LEAD_CAPTURE" | "SCALE"
  reasons         String?  // JSON array of reasons
  actions         String?  // JSON array of proposed actions
  
  createdAt       DateTime @default(now())

  @@index([placeId])
}
